---
version: '3'

networks:
  frontend:
    name: proxy
    external: true
  backend:

volumes:
  nextcloud-db-data:
    external: true
    name: nextcloud-db-data

services:
  nextcloud-app:
    container_name: nextcloud-app
    image: nextcloud:32
    restart: unless-stopped
    depends_on:
      - nextcloud-db
      - nextcloud-redis
    ports:
      - "${NC_PORT:-80}:80"
    volumes:
      - ${LOCAL_ROOT:-/srv}/nextcloud/config:/var/www/html/config:rw
      - ${LOCAL_ROOT:-/srv}/nextcloud/custom_apps:/var/www/html/custom_apps:rw
      - ${LOCAL_ROOT:-/srv}/nextcloud/themes:/var/www/html/themes:rw
      - ${DATA_ROOT:-/mnt/data}/nextcloud/data:/var/www/html/data:rw
    env_file:
      - .env
    environment:
      PHP_OPCACHE_JIT: 0
      PHP_OPCACHE_JIT_BUFFER_SIZE: 0
      PHP_UPLOAD_LIMIT: 10G
      PHP_MEMORY_LIMIT: 512M
      APACHE_BODY_LIMIT: 0
      # DB vars (MYSQL_*) come from .env
    networks:
      - backend

  nextcloud-db:
    container_name: nextcloud-db
    image: mariadb:11.4.8
    restart: unless-stopped
    command: >
      --transaction-isolation=READ-COMMITTED
      --binlog-format=ROW
      --innodb-file-per-table=1
      --skip-innodb-read-only-compressed
    volumes:
      - nextcloud-db-data:/var/lib/mysql
    env_file:
      - .env
    networks:
      - backend

  nextcloud-redis:
    container_name: nextcloud-redis
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    networks:
      - backend

  appapi-harp:
    image: ghcr.io/nextcloud/nextcloud-appapi-harp:release
    container_name: nextcloud-appapi-harp
    hostname: appapi-harp
    restart: unless-stopped
    # SECURITY NOTE: In a rootless Podman environment, "0" maps to the unprivileged
    # host user. If running in rootful Docker, change this to your PUID:PGID.
    user: "0"
    depends_on:
      - nextcloud-app
    ports:
      - "${APPAPI_PORT_EXAPPS:-8780}:8780"
      - "${APPAPI_PORT_FRP:-8782}:8782"
    env_file:
      - .env
    environment:
      NC_INSTANCE_URL: "https://${NC_DOMAIN}"
      HP_TRUSTED_PROXY_IPS: ${HP_TRUSTED_PROXY_IPS}
      HP_LOG_LEVEL: "info"
      HP_VERBOSE_START: "1"
      # HP_SHARED_KEY comes from .env
    volumes:
      - /run/user/1000/podman/podman.sock:/var/run/docker.sock
      - ${DATA_ROOT:-/mnt/data}/nextcloud/harp-certs:/certs
    networks:
      # - backend
      - frontend
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS -H \"harp-shared-key: $$HP_SHARED_KEY\" -H \"docker-engine-port: 24000\" http://127.0.0.1:8780/exapps/app_api/v1.41/_ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
